#!/bin/bash
source "$(dirname "$0")/fonctions.sh"

# --- Commande UTILISER ---
# Utilise un objet de l'inventaire du joueur

OBJET=$1
STATS_DIR=$(dirname "$0")/../DONJON/stats
INVENTAIRE="$STATS_DIR/inventaire.txt"
ETAT_COMBAT_FILE="$STATS_DIR/etat_combat"

# --- 1. Vérifications de base ---

if [ -z "$OBJET" ]; then
  echo "Quel objet de l'inventaire voulez-vous utiliser ? (ex: utiliser potion_soin)"
  exit 1
fi

# Vérifie si l'objet est dans l'inventaire
if ! grep -q "^$OBJET$" "$INVENTAIRE"; then
  echo "Vous n'avez pas de '$OBJET' dans votre inventaire."
  exit 1
fi

# --- 2. Logique d'utilisation (Soin) ---

case $OBJET in
    "potion_soin")
        # Récupération des PV du joueur depuis PV_STATS
        HP_MAX=$(lire_pv_max "$STATS_DIR/PV_STATS")
        HP_CURRENT=$(lire_pv "$STATS_DIR/PV_STATS")
        
        # Rend 5 à 8 PV
        SOIN=$((5 + $RANDOM % 4))
        
        HP_APRES=$(($HP_CURRENT + $SOIN))
        
        # Limite le soin au PV Max
        if [ "$HP_APRES" -gt "$HP_MAX" ]; then
            HP_APRES="$HP_MAX"
        fi

        echo "Vous buvez la Potion de Soin et récupérez $SOIN PV."
        pause
        echo "Vos PV sont maintenant : $HP_APRES / $HP_MAX."
        
        # Sauvegarde des PV au format Actuel/Max
        ecrire_pv "$STATS_DIR/PV_STATS" "$HP_APRES"
        
        ;;
	"potion_mana")
		# Récupération des PE du joueur depuis PE_STATS
        PE_MAX=$(lire_pv_max "$STATS_DIR/PE_STATS")
        PE_CURRENT=$(lire_pv "$STATS_DIR/PE_STATS")
        
        # Rend 5 à 8 PV
        SOIN=$((5 + $RANDOM % 4))
        
        PE_APRES=$(($PE_CURRENT + $SOIN))
        
        # Limite le soin au PE Max
        if [ "$PE_APRES" -gt "$PE_MAX" ]; then
            PE_APRES="$PE_MAX"
        fi

        echo "Vous buvez la Potion de Mana et récupérez $SOIN PE."
        pause
        echo "Vos PE sont maintenant : $PE_APRES / $PE_MAX."
        
        # Sauvegarde des PE au format Actuel/Max
        ecrire_pv "$STATS_DIR/PE_STATS" "$PE_APRES"
        
        ;;
		
	# --- NOUVEAU : LOGIQUE DES TRÉSORS ---
    "epee_magique")
        echo "Vous sentez la puissance de l'épée magique... Votre attaque augmente !"
        pause
        # Lit la stat actuelle, l'augmente de 5, et la sauvegarde
        ATK_BASE=$(cat "$STATS_DIR/attaque_base")
        ATK_BASE=$(($ATK_BASE + 5))
        echo "$ATK_BASE" > "$STATS_DIR/attaque_base"
        echo "Attaque de base : $ATK_BASE"
        ;;
    
    "baton_ancien")
        echo "Le bâton ancien crépite d'énergie... Votre magie augmente !"
        pause
        MAG_BASE=$(cat "$STATS_DIR/magie_base")
        MAG_BASE=$(($MAG_BASE + 5))
        echo "$MAG_BASE" > "$STATS_DIR/magie_base"
        echo "Magie de base : $MAG_BASE"
        ;;

    "armure_ancestrale")
        echo "L'armure ancestrale s'ajuste à vous... Vos PV et PE maximums augmentent !"
        pause
        
        # Logique PV (Manuelle, car ecrire_pv ne change pas le Max)
        PV_CURRENT=$(lire_pv "$STATS_DIR/PV_STATS")
        PV_MAX=$(lire_pv_max "$STATS_DIR/PV_STATS")
        PV_CURRENT=$(($PV_CURRENT + 5))
        PV_MAX=$(($PV_MAX + 5))
        echo "$PV_CURRENT/$PV_MAX" > "$STATS_DIR/PV_STATS"

        # Logique PE (Manuelle)
        PE_CURRENT=$(lire_pv "$STATS_DIR/PE_STATS")
        PE_MAX=$(lire_pv_max "$STATS_DIR/PE_STATS")
        PE_CURRENT=$(($PE_CURRENT + 5))
        PE_MAX=$(($PE_MAX + 5))
        echo "$PE_CURRENT/$PE_MAX" > "$STATS_DIR/PE_STATS"

        echo "Vos stats ont été améliorées."
        ;;	
			
        
    *)
        echo "L'objet '$OBJET' ne peut pas être utilisé de cette manière."
        exit 1
        ;;
esac

# --- 3. Retrait de l'objet de l'inventaire ---
# Retire la première occurrence de l'objet
LIGNE_A_SUPPRIMER=$(grep -n "^$OBJET$" "$INVENTAIRE" | head -n 1 | cut -d: -f1)

# 2. Si une ligne a été trouvée, la supprimer par son numéro exact
if [ ! -z "$LIGNE_A_SUPPRIMER" ]; then
    sed -i.bak "${LIGNE_A_SUPPRIMER}d" "$INVENTAIRE"
    rm "$INVENTAIRE.bak" 2>/dev/null
    echo "L'objet $OBJET a été retiré de l'inventaire."
else
    # S'il y a un bug, au moins l'objet n'est pas supprimé
    echo "ERREUR: N'a pas pu trouver $OBJET à supprimer (Bug)."
fi
pause

# ----------------------------------------------------
# --- 4. Riposte de l'Ennemi (Correction PV_STATS) ---
# ----------------------------------------------------

# Vérifie si un combat est en cours
if [ -f "$ETAT_COMBAT_FILE" ]; then
    CIBLE=$(cat "$ETAT_COMBAT_FILE")

    # NOUVEAU : Calcul de l'esquive (25% de chance)
    if [ $(($RANDOM % 4)) -eq 0 ]; then
        echo "L'ennemi tente de vous frapper pendant que vous buvez, mais vous esquivez !"
        pause
    else
        # Riposte normale
        echo "L'ennemi profite de votre moment d'inattention pour riposter !"
        pause

        DMG_ENNEMI=$((2 + $RANDOM % 2))

        # Lecture des PV et calcul des dégâts
        PLAYER_HP_CURRENT=$(lire_pv "$STATS_DIR/PV_STATS")
        PLAYER_HP_CURRENT_APRES=$(($PLAYER_HP_CURRENT - $DMG_ENNEMI))

        # CHANGEMENT DU MESSAGE : générique pour éviter les problèmes de genre
        echo "Une riposte vous frappe et inflige $DMG_ENNEMI points de dégâts !"
        pause

        # Sauvegarde des PV du joueur
        PLAYER_HP_MAX=$(lire_pv_max "$STATS_DIR/PV_STATS")
        ecrire_pv "$STATS_DIR/PV_STATS" "$PLAYER_HP_CURRENT_APRES"

        # Vérification : Le joueur est-il mort ?
        check_mort
    fi
	echo "Vos PV: $PLAYER_HP_CURRENT_APRES / $PLAYER_HP_MAX"
    echo "Combat en cours."
fi
