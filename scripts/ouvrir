#!/bin/bash
source "$(dirname "$0")/fonctions.sh"
# --- Commande OUVRIR ---
# Interagit avec un coffre ou autre conteneur dans la salle

CIBLE=$1
STATS_DIR=$(dirname "$0")/../DONJON/stats
INVENTAIRE="$STATS_DIR/inventaire.txt"

# --- 1. Vérifications de base et sécurité ---

if [ -z "$CIBLE" ]; then
  echo "Que voulez-vous ouvrir ? (ex: ouvrir coffre.txt)"
  exit 1
fi

# Sécurité critique : On doit seulement ouvrir un objet qui est un fichier
# ET dont le nom contient "coffre" (pour éviter d'ouvrir un ennemi)
if [ ! -f "$CIBLE" ]; then
    echo "L'objet '$CIBLE' n'existe pas ici."
    exit 1
fi

if [[ ! "$CIBLE" =~ "coffre" ]]; then
  echo "Vous ne pouvez pas ouvrir un $CIBLE. Essayez 'ouvrir coffre.txt'."
  exit 1
fi

# --- 2. Lecture du Contenu ---
# On lit le type de loot à l'intérieur du fichier cible
CONTENU=$(cat "$CIBLE")

# --- 3. Logique des Contenus (Le Rogue-like) ---

case $CONTENU in
    "potion_soin")
        echo "Le coffre contenait une Potion de Soin !"
        echo "potion_soin" >> "$INVENTAIRE" # Ajoute l'objet
		# --- NOUVEAU : Chance d'une double potion (1 chance sur 4) ---
		BONUS=$(($RANDOM % 4))
		if [ "$BONUS" -eq 0 ]; then
			echo "potion_soin" >> "$FICHIER_COFFRE" # Ajoute la seconde potion
			echo "Oh ! Et vous trouvez une deuxième potion de soin, c'est votre jour de chance !"
		elif [ "$BONUS" -eq 1 ]; then
			echo "potion_mana" >> "$FICHIER_COFFRE" # Ajoute la seconde potion
			echo "Oh ! Et vous trouvez une potion de mana également, c'est votre jour de chance !"
		fi
        ;;

    "piège_flechette")
        # --- LOGIQUE DU PIÈGE (LA FLÈCHE EMPOISONNÉE) ---
        echo "C'est un piège ! Une fléchette empoisonnée vous pique."
        pause
        # Perte de PV aléatoire (entre 1 et 3)
        DMG_PIEGE=$((1 + $RANDOM % 3)) 
        
        HP_CURRENT=$(lire_pv "$STATS_DIR/PV_STATS")
        HP_CURRENT=$(($HP_CURRENT - $DMG_PIEGE))
        
        # Sauvegarde des PV
        ecrire_pv "$STATS_DIR/PV_STATS" "$HP_CURRENT"
        
        echo "Vous perdez $DMG_PIEGE PV. PV restants : $HP_CURRENT."
        pause
        # Vérification de mort (copiée/collée de attaquer)
        check_mort
        ;;
	"indice_magie")
        NOTE_NOM="note_mysterieuse.txt"
        
        echo "Le coffre contenait une vieille note recouverte de poussière."
        pause
        echo "Vous la laissez dans la salle pour la lire (fichier $NOTE_NOM) et son contenu est automatiquement sauvegardé dans vos notes."
        
        # 1. Écriture de l'indice DANS LA SALLE
        echo "Le rituel est simple : Pour enflammer la cible, le mot clef est 'ROUGE'." > "$NOTE_NOM"
        echo "Ce n'est qu'en cherchant 'ROUGE' que le sort apparaitra..." >> "$NOTE_NOM"
        echo "" >> "$NOTE_NOM"
        echo "Le temps s'égrène lentement, mais seul le feu ROUGE triomphe." >> "$NOTE_NOM"
        echo "Sort : sort_feu" >> "$NOTE_NOM"
        
        # 2. Sauvegarde du contenu dans le fichier de notes global (pour le 'grep')
        cat "$NOTE_NOM" >> "$STATS_DIR/notes.txt"
        
        # Le fichier coffre.txt sera supprimé plus tard dans le script.
        ;;
	"indice_soin")
        # --- NOUVELLE ÉNIGME (SOIN) ---
        NOTE_NOM="note_runique.txt"
        echo "Le coffre contenait une rune humide gravée dans la pierre."
        pause
        echo "Vous la laissez dans la salle (fichier $NOTE_NOM) et son contenu est sauvegardé dans vos notes."
        
        # Écriture de l'indice DANS LA SALLE
        echo "La rune est froide au toucher. Elle dit :" > "$NOTE_NOM"
        echo "Pour apaiser la douleur, le mot clef est 'BLEU'." >> "$NOTE_NOM"
        echo "Sort : sort_soin" >> "$NOTE_NOM"
        
        # Sauvegarde du contenu dans le fichier de notes global
        cat "$NOTE_NOM" >> "$STATS_DIR/notes.txt"
        ;;
	"cle_secrete")
        echo "Le coffre contenait une 'cle_secrete' en fer."
        pause
        echo "cle_secrete a été ajoutée à votre inventaire."
        echo "cle_secrete" >> "$INVENTAIRE" # Ajoute la clé
        ;;	
    *) # Si le fichier contenait autre chose (un objet non géré)
        echo "Le coffre contenait : $CONTENU (Objet inconnu)"
        ;;
esac

# --- 4. Nettoyage et Fin ---
rm "$CIBLE"
echo "Le coffre est vide et disparaît de la salle."
