#!/bin/bash
source "$(dirname "$0")/fonctions.sh"

CIBLE=$1
STATS_DIR=$(dirname "$0")/../DONJON/stats

# --- 1. Vérifications (Ennemi et Joueur) ---

if [ -z "$CIBLE" ]; then
  echo "Qui voulez-vous attaquer ? (ex: attaquer <cible>)"
  exit 1
fi

if [ ! -e "$CIBLE" ]; then
  echo "Il n'y a pas de '$CIBLE' ici."
  exit 1
fi

# Lit les PV ACTUELS de l'ennemi (le X de X/Y)
ENNEMI_HP=$(lire_pv "$CIBLE")

if [ "$ENNEMI_HP" -le 0 ]; then
  echo "$CIBLE est déjà vaincu. Choisissez une autre cible."
  exit 1
fi

# Lit les PV ACTUELS du joueur (Utilise lire_pv sur PV_STATS)
PLAYER_HP_CURRENT=$(lire_pv "$STATS_DIR/PV_STATS")

check_mort

# CRÉATION DU VERROU DE COMBAT : Après avoir vérifié que tout le monde est en vie.
echo "$CIBLE" > "$STATS_DIR/etat_combat"

# --- 2. Tour du Joueur ---

echo "--- Début du tour ---"
pause

PLAYER_ATK=$(cat "$STATS_DIR/attaque_base")
ENNEMI_HP_MAX=$(lire_pv_max "$CIBLE") # Récupère le PV Max de l'ennemi

# Calcul des dégâts
DMG_JOUEUR=$(($PLAYER_ATK + $RANDOM % 3))
ENNEMI_HP_APRES=$(($ENNEMI_HP - $DMG_JOUEUR)) 

echo "Vous attaquez $CIBLE et infligez $DMG_JOUEUR points de dégâts !"
pause

# Sauvegarde des PV de l'ennemi au format X/Max
ecrire_pv "$CIBLE" "$ENNEMI_HP_APRES"

# --- 3. Vérification : L'ennemi est-il mort ? ---

if [ "$ENNEMI_HP_APRES" -le 0 ]; then
  echo "Vous avez vaincu le $CIBLE !"
  pause
  rm "$CIBLE"
  # --- NOUVELLE VÉRIFICATION CRITIQUE : Compte tous les ennemis ---

    # Cette commande compte tous les fichiers ennemis dans le répertoire actuel.
    # Le '.' représente le répertoire courant.
    NB_ENNEMIS_RESTANTS=$(ls -A . | grep -E -c "(rat|gobelin|squelette|rat_mutant|rat_chetif)")

    if [ "$NB_ENNEMIS_RESTANTS" -eq 0 ]; then
        # CAS 1: Plus aucun ennemi dans la salle
        echo "La menace est écartée. Vous êtes hors combat."
        rm "$STATS_DIR/etat_combat" # ⬅️ ON NE RETIRE LE VERROU QU'ICI
    else
        # CAS 2: Il reste des ennemis
        echo "Victoire sur $CIBLE !"
        pause
        echo "Mais vous êtes toujours en combat ! Il reste $NB_ENNEMIS_RESTANTS ennemi(s) :"
        ls -A . | grep -E "(rat|gobelin|squelette|rat_mutant|rat_chetif)"
        # Note : Le verrou 'etat_combat' est MAINTENU.
    fi

    echo "---------------------"
    exit 0
fi

# --- 4. Tour de l'Ennemi (s'il est vivant) ---

# Initialiser les PV pour l'affichage final (on utilise les PV AVANT riposte)
# Ceci est CRUCIAL pour les cas d'esquive.
PLAYER_HP_CURRENT_APRES=$(lire_pv "$STATS_DIR/PV_STATS")
PLAYER_HP_MAX=$(lire_pv_max "$STATS_DIR/PV_STATS")

# NOUVEAU : Calcul de l'esquive (25% de chance)
if [ $(($RANDOM % 4)) -eq 0 ]; then # 1 chance sur 4 (0, 1, 2, 3)
    echo "$CIBLE frappe... mais vous esquivez son attaque de justesse !"
    pause
    # On passe la riposte, pas de dégâts infligés.
else
    # Riposte normale (si l'esquive a échoué)
    DMG_ENNEMI=$((2 + $RANDOM % 2))
    PLAYER_HP_CURRENT=$(lire_pv "$STATS_DIR/PV_STATS")
    PLAYER_HP_CURRENT_APRES=$(($PLAYER_HP_CURRENT - $DMG_ENNEMI))

    echo "$CIBLE riposte et vous frappe pour $DMG_ENNEMI points de dégâts !"
    pause

    # Sauvegarde des PV du joueur
    PLAYER_HP_MAX=$(lire_pv_max "$STATS_DIR/PV_STATS")
    ecrire_pv "$STATS_DIR/PV_STATS" "$PLAYER_HP_CURRENT_APRES"

# --- 5. Vérification : Le joueur est-il mort ? ---

	check_mort
fi
# --- 6. Fin du tour ---

echo "--- Fin du tour ---"
echo "Vos PV: $PLAYER_HP_CURRENT_APRES / $PLAYER_HP_MAX"
echo "PV $CIBLE: $ENNEMI_HP_APRES / $ENNEMI_HP_MAX"
echo "-------------------"