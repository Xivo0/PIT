#!/bin/bash
source "$(dirname "$0")/fonctions.sh"

#Récupère le chemin de la porte qui a appelé ce script
PORTE_A_SUPPRIMER=$1
# --- VÉRIFICATION DE SÉCURITÉ (Clé d'accès) ---
# Le script doit être appelé depuis un dossier qui contient le fichier TEMPORAIRE .__ACCES_SALLE_OK__.

if [ ! -f .__ACCES_SALLE_OK__ ]; then
    echo "ACCÈS REFUSÉ. Ce script doit être appelé par une porte déverrouillée."
    exit 1
fi

# Supprime la clé immédiatement après la vérification (sécurité à usage unique)
rm .__ACCES_SALLE_OK__

# --- Moteur de Génération de Salle (avec logique Boss) ---

# --- PARAMÈTRES DU JEU ---
MAX_SALLES_AVANT_BOSS=3

echo "Vous tournez la poignée..."
pause

# 1. Définir les chemins
SALLE_DIR="$(dirname "$0")/../DONJON/salles" # Raccourci vers le dossier des salles

# On compte le nombre de salles déjà créées sur cet étage
# On cherche tout ce qui commence par 'entree' OU 'salle_'
NB_SALLES=$(ls -d "$SALLE_DIR"/* 2>/dev/null | grep -E -c "(entree|salle_[0-9]+)")

# ----------------------------------------------------
# 2. LOGIQUE DE FIN D'ÉTAGE (BOSS FINAL)
# ----------------------------------------------------

# Si on a créé assez de salles, on crée le Boss
if [ "$NB_SALLES" -gt "$MAX_SALLES_AVANT_BOSS" ]; then
    
    # --- Création du Boss ---
    echo "Vous avez atteint le fond du Donjon... Un souffle glacial vous traverse."
	pause
    NOUVELLE_SALLE="salle_boss"
    CHEMIN_NOUVELLE_SALLE="$SALLE_DIR/$NOUVELLE_SALLE"

    if mkdir "$CHEMIN_NOUVELLE_SALLE"; then
        echo "La salle finale s'ouvre : $NOUVELLE_SALLE"
    else
        echo "La salle du Boss existe déjà. Entrez avec : cd ../$NOUVELLE_SALLE"
        exit 0
    fi
    
    # Fichier du Boss : PV/PV_Max (prépare l'amélioration des stats)
    echo "30/30" > "$CHEMIN_NOUVELLE_SALLE/BOSS_FINAL"
    
    # Message d'accueil du Boss
    cat << EOF > "$CHEMIN_NOUVELLE_SALLE/message.txt"
*** BIENVENUE DANS LA SALLE DU BOSS FINAL ***

Le BOSS_FINAL se dresse devant vous.
Il est temps de montrer votre courage !
EOF
    
    # Porte de FIN (elle n'appelle plus la génération)
    cat << EOF > "$CHEMIN_NOUVELLE_SALLE/porte_suivante"
#!/bin/bash
# --- Script de Porte du Boss Vaincu ---
SALLE_ACTUELLE=\$(dirname "\$0")
NB_ENNEMIS=\$(ls -A "\$SALLE_ACTUELLE" | grep -E -c "(rat|gobelin|squelette|BOSS_FINAL)")

if [ "\$NB_ENNEMIS" -gt 0 ]; then
    echo "Le BOSS FINAL vous empêche de fuir ou de continuer."
    exit 1
fi

echo "Vous avez VAINCU le BOSS FINAL !"
echo "--------------------------------------------------------"
echo "           VICTOIRE ! BASH QUEST EST TERMINÉ !"
echo "--------------------------------------------------------"
echo "Un escalier s'ouvre. Vous sortez du donjon. Vous êtes libre."
# Sortie du jeu (on quitte le dossier de jeu pour revenir à la racine du projet)
cd ../../../../..
exit 0
EOF
    
    # Rendre la porte exécutable
    chmod +x "$CHEMIN_NOUVELLE_SALLE/porte_suivante"

# ----------------------------------------------------
# 3. LOGIQUE DE SALLE NORMALE (ALÉATOIRE)
# ----------------------------------------------------
else	
    STATS_DIR="$(dirname "$0")/../DONJON/stats"
    CLASSE_JOUEUR=$(cat "$STATS_DIR/classe")
    # --- Création de la Salle Normale ---
    NOUVELLE_SALLE="salle_$((NB_SALLES + 1))"
    CHEMIN_NOUVELLE_SALLE="$SALLE_DIR/$NOUVELLE_SALLE"

    if mkdir "$CHEMIN_NOUVELLE_SALLE"; then
        echo "La porte s'ouvre sur une nouvelle salle : $NOUVELLE_SALLE"
		pause
    else
        echo "La porte semble déjà ouverte... Entrez avec : cd ../$NOUVELLE_SALLE"
        exit 0
    fi
    
    # --- Génération Aléatoire ---
    echo "La salle se matérialise devant vous..."
    pause
    # Ennemi garanti : Squelette
    echo "Un Squelette se dresse devant vous !"
    echo "10/10" > "$CHEMIN_NOUVELLE_SALLE/squelette"
	pause

    # Ennemi supplémentaire ? (1 chance sur 2)
    if [ $(($RANDOM % 2)) -eq 0 ]; then
        echo "Il est accompagné d'un gobelin !"
        echo "8/8" > "$CHEMIN_NOUVELLE_SALLE/gobelin"
		pause
    fi

    # Coffre (piégé ou non, 4 chances sur 5)
	COFFRE_APPARITION=$(($RANDOM % 5))
    case "$COFFRE_APPARITION" in
	
		0|1|2|3)
	
			echo
			# AFFICHAGE ASCII DU COFFRE :
			echo "  _______"
			echo " |_______| Vous apercevez un coffre."
			echo " | | | | | (Utilisez 'ouvrir coffre.txt' pour l'ouvrir)"
			echo " |_|_|_|_|"
			echo
			pause
			
			# Dé de 7 faces : 0-1=Potion_soin, 2=Piège, 3=Indice Feu, 4=Indice Soin, 5-6=Potion_mana
			LOOT_TYPE=$(($RANDOM % 7))
		
			case "$LOOT_TYPE" in
				0|1)
					echo "potion_soin" > "$CHEMIN_NOUVELLE_SALLE/coffre.txt"
					;;
				2)	
					echo "piège_flechette" > "$CHEMIN_NOUVELLE_SALLE/coffre.txt"
					;;
				3)
					echo "indice_magie" > "$CHEMIN_NOUVELLE_SALLE/coffre.txt"
					;;
				4)
					echo "indice_soin" > "$CHEMIN_NOUVELLE_SALLE/coffre.txt"
					;;
				5|6)
					echo "potion_mana" > "$CHEMIN_NOUVELLE_SALLE/coffre.txt"
					;;
			esac
				# ------------------------------------------------------------------
				# LOGIQUE DU COFFRE BONUS (Utilise la classe du joueur)
				# ------------------------------------------------------------------

			TIRAGE_MAX=0
			SEUIL_REUSSITE=0

			# 1. Détermination du bonus de classe (SEUIL_REUSSITE représente le nombre de cas où on réussit)
			if [ "$CLASSE_JOUEUR" == "Voleur" ]; then
			    # Voleur : 2 chances sur 3 (Tirage sur 3, Réussite si < 2)
			    TIRAGE_MAX=3
			    SEUIL_REUSSITE=2 
			elif [ "$CLASSE_JOUEUR" == "Paysan" ]; then
			    # Paysan : 1 chance sur 5 (Tirage sur 5, Réussite si < 1)
			    TIRAGE_MAX=5
			    SEUIL_REUSSITE=1
			else
			    # Guerrier/Mage : 1 chance sur 4 (Tirage sur 4, Réussite si < 1)
			    TIRAGE_MAX=4
			    SEUIL_REUSSITE=1
			fi

			# 2. Jet de dés du coffre bonus
			JET_BONUS=$(($RANDOM % $TIRAGE_MAX))

			# Le coffre apparaît si le jet est inférieur au SEUIL
			if [ "$JET_BONUS" -lt "$SEUIL_REUSSITE" ]; then
			    
			    echo "Vous trouvez un deuxième coffre dissimulé ! ('coffre_bonus.txt')"
			    pause
			    
			    # Le coffre bonus a un loot simple (potion ou indice)
			    LOOT_TYPE=$(($RANDOM % 7))
		
				case "$LOOT_TYPE" in
					0|1)
						echo "potion_soin" > "$CHEMIN_NOUVELLE_SALLE/coffre_bonus.txt"
						;;
					2)	
						echo "piège_flechette" > "$CHEMIN_NOUVELLE_SALLE/coffre_bonus.txt"
						;;
					3)
						echo "indice_magie" > "$CHEMIN_NOUVELLE_SALLE/coffre_bonus.txt"
						;;
					4)
						echo "indice_soin" > "$CHEMIN_NOUVELLE_SALLE/coffre_bonus.txt"
						;;
					5|6)
						echo "potion_mana" > "$CHEMIN_NOUVELLE_SALLE/coffre_bonus.txt"
						;;
				esac
			    
			    # AFFICHAGE ASCII DU COFFRE BONUS :
			    echo "  _______"
			    echo " |_______| Un coffre bonus apparaît."
			    echo " | | | | | (Utilisez 'ouvrir coffre_bonus.txt')"
			    echo " |_|_|_|_|"
			    echo
			    
			fi
			;;
		4)
			;;
	esac
	
    
	# 1 chance sur 2 de trouver une clé au sol
    if [ $(($RANDOM % 2)) -eq 0 ]; then
        echo "Vous remarquez quelque chose qui brille par terre : 'cle_secrete'."
        pause
        # On crée le fichier .item pour que 'ramasser' sache quoi prendre
        echo "cle_secrete" > "$CHEMIN_NOUVELLE_SALLE/cle_secrete.item"
    fi
	
	# 1 chance sur 2 de générer une porte secrète
if [ $(($RANDOM % 2)) -eq 0 ]; then
    
    echo "Un passage dissimulé dans le mur attire votre attention : 'porte_secrete'."
    pause
    
    # On crée le script de la porte secrète
    cat << EOF > "$CHEMIN_NOUVELLE_SALLE/porte_secrete"
#!/bin/bash
source "\$(dirname "\$0")/../../../scripts/fonctions.sh"
STATS_DIR="\$(dirname "\$0")/../../../DONJON/stats"
INVENTAIRE_FILE="\$STATS_DIR/inventaire.txt"
CLE_REQUISE="cle_secrete"
SALLE_SECRETE_DIR="\$(dirname "\$0")/salle_secrete_tresor"

echo "Vous examinez la 'porte_secrete'..."
pause

# 1. La salle secrète existe-t-elle déjà ?
if [ -d "\$SALLE_SECRETE_DIR" ]; then
    echo "La porte est déjà ouverte."
    echo "Entrez avec : cd ./salle_secrete_tresor"
    # La porte a déjà été utilisée, mais n'a pas été supprimée ? On la supprime maintenant.
    rm "\$0"
    exit 0
fi

# 2. NON : La salle n'existe pas. Vérifions la clé.
if ! grep -q "^\$CLE_REQUISE$" "\$INVENTAIRE_FILE"; then
    echo "Elle est verrouillée. Il manque une 'cle_secrete'."
    exit 1
fi

# 3. OUI : Le joueur a la clé ET la salle n'existe pas.
echo "Vous insérez la \$CLE_REQUISE... La serrure grince et s'ouvre !"
pause
echo "Vous insérez la \$CLE_REQUISE... La serrure grince et s'ouvre !"
pause

# 1. Trouver le NUMÉRO de la première ligne correspondant à la clé
LIGNE_CLE=\$(grep -n "^\$CLE_REQUISE$" "\$INVENTAIRE_FILE" | head -n 1 | cut -d: -f1)

# 2. Si une ligne a été trouvée, la supprimer par son numéro exact
if [ ! -z "\$LIGNE_CLE" ]; then
    sed -i.bak "\${LIGNE_CLE}d" "\$INVENTAIRE_FILE"
    rm "\$INVENTAIRE_FILE.bak" 2>/dev/null
fi

# Création de la salle secrète
mkdir "\$SALLE_SECRETE_DIR"
echo "La porte s'ouvre sur : salle_secrete_tresor"
echo "20/20" > "\$SALLE_SECRETE_DIR/gardien_du_tresor"

LOOT_TRESOR=\$(($RANDOM % 3))

case "\$LOOT_TRESOR" in

0) TRESOR_ITEM="epee_magique" ;;

1) TRESOR_ITEM="baton_ancien" ;;

2) TRESOR_ITEM="armure_ancestrale" ;;

esac
echo "\$TRESOR_ITEM" > "\$SALLE_SECRETE_DIR/tresor.loot"
echo "Le trésor est gardé !" > "\$SALLE_SECRETE_DIR/message.txt"

echo "Entrez avec : cd ./salle_secrete_tresor"
pause

# --- AUTO-DESTRUCTION (VOTRE IDÉE) ---
echo "La porte secrète se fond dans le mur derrière vous, disparaissant."
rm "\$0" # Le script 'porte_secrete' se supprime lui-même.
EOF

    chmod +x "$CHEMIN_NOUVELLE_SALLE/porte_secrete"
fi
	
    # --- Création de la porte suivante ---
    # On écrit le script de porte VERROUILLÉE dans la NOUVELLE salle
    cat << EOF > "$CHEMIN_NOUVELLE_SALLE/porte_suivante"
#!/bin/bash
# --- Script de Porte Verrouillée ---
SALLE_ACTUELLE=\$(dirname "\$0")

# On compte les ennemis (utilisation de la liste d'ennemis déjà définie)
NB_ENNEMIS=\$(ls -A "\$SALLE_ACTUELLE" | grep -E -c "(rat|gobelin|squelette|rat_mutant|rat_chetif)")

if [ "\$NB_ENNEMIS" -gt 0 ]; then
    echo "La porte est verrouillée. Il reste \$NB_ENNEMIS ennemi(s) :"
    ls -A "\$SALLE_ACTUELLE" | grep -E "(rat|gobelin|squelette|rat_mutant|rat_chetif)"
    exit 1
fi

echo "Vous avez nettoyé la salle. La porte se déverrouille..."

# CRÉATION DE LA CLÉ TEMPORAIRE DANS LA SALLE ACTUELLE
# Cette clé autorise generer_salle à s'exécuter.
touch .__ACCES_SALLE_OK__
# On appelle le moteur de génération
exec "\$(dirname "\$0")/../../../scripts/generer_salle" "\$0"
EOF

    # On la rend exécutable
    chmod +x "$CHEMIN_NOUVELLE_SALLE/porte_suivante"
fi

# 4. Instruction finale
if [ -f "$PORTE_A_SUPPRIMER" ]; then
    rm "$PORTE_A_SUPPRIMER"
fi
echo "Pour entrer dans la nouvelle salle, tapez : cd ../$NOUVELLE_SALLE"
